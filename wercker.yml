box: wercker/ruby
build:
  steps:
    - script:
        name: Download release
        code: curl -O "http://download.geteventstore.com/binaries/eventstore-mono-2.0.1.tgz"
    - script: 
        name: Unpack
        code: |-
              mkdir ./eventstore-bin
              tar xvfz eventstore-mono-2.0.1.tgz -C ./eventstore-bin
    - script:
        name: Install docker
        code: curl get.docker.io | sudo sh -x
    - script:
        name: docker version
        code: |
              docker -v
              sudo groupadd docker
              sudo usermod -aG docker koudaiii
              sudo chmod 777 /var/run/docker.sock
              sudo docker -d
    - script:
        name: gem install
        code: sudo gem install serverspec --no-ri --no-rdoc
    - script:
        name: Get Vagrant
        code: wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.6.3_x86_64.deb
    - script:
        name: Install Vagrant
        code: |
              sudo dpkg -i vagrant_1.6.3_x86_64.deb
              sudo apt-get install virtualbox
              sudo  vagrant plugin install vagrant-vbguest
    - script:                                                                                                                                                                           
        name: docker setting
        code: |
              export DOCKER_HOST=tcp://localhost:4243
              sudo ln -sf /usr/bin/docker /usr/local/bin/docker
#              sudo useradd vagrant
#              sudo usermod -aG docker vagrant
    - script:
        name: Run vagrant up
        code: sudo vagrant up --provider=docker
#    - script:
#        name: Run rake spec:app
#        code: rake spec:app
#    - script:
#        name: Run rake spec:proxy
#        code: rake spec:proxy
  after-steps:
    - script:
        name: Run vagrant destroy
        code: vagrant destroy --force
